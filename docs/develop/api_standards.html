<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API Standards</title>
    <link rel="stylesheet" href="../style.css" />
    <script src="../menu.js"></script>
</head>
<body>
    <div class="header-logo">
      <img src="../images/logo.png" alt="Credex Logo" class="secondary-logo" />
    </div>
    <h1>API Standards</h1>

    <p>This document outlines the standardization requirements for all API endpoints in the credex-core project.</p>

    <h2>Module Organization</h2>

    <ul>
        <li><strong>Member Module:</strong> Member management and authentication</li>
        <li><strong>Account Module:</strong> Account operations and management</li>
        <li><strong>Credex Module:</strong> Credex transaction operations</li>
        <li><strong>Recurring Module:</strong> Recurring payment management</li>
        <li><strong>Avatar Module:</strong> Avatar-specific operations</li>
        <li><strong>Admin Module:</strong> Production environment administration</li>
        <li><strong>DevAdmin Module:</strong> Development environment utilities (not deployed to production)</li>
    </ul>

    <h2>Module Structure</h2>
    <p>Each module follows a consistent structure:</p>
    <pre><code>src/api/ModuleName/
├── moduleRoutes.ts
├── moduleValidationSchemas.ts
├── controllers/
│   └── specific controllers...
└── services/
    └── specific services...</code></pre>

    <h2>Route Standards</h2>

    <h3>HTTP Method</h3>
    <p>All endpoints must use the POST method for consistency, including operations that might traditionally use other HTTP methods.</p>

    <h3>Path Format</h3>
    <p>Regular endpoints follow the format: <code>/v1/[operation]</code></p>
    <p>Examples:</p>
    <ul>
        <li><code>/v1/getMemberByHandle</code></li>
        <li><code>/v1/createAccount</code></li>
    </ul>

    <p>Admin and DevAdmin endpoints follow the format: <code>/v1/[module]/[operation]</code></p>
    <ul>
        <li><code>/v1/admin/getCredexDetails</code></li>
    </ul>

    <h2>Request Format</h2>

    <h3>Headers</h3>
    <pre><code>{
  "Content-Type": "application/json",
  "Authorization": "Bearer [token]",  // Required for authenticated routes
  "x-client-api-key": "[key]"        // Required for keyhole routes
}</code></pre>

    <h3>Body</h3>
    <p>All request parameters must be in the request body, not query parameters:</p>
    <pre><code>{
  "param1": "value1",
  "param2": "value2"
}</code></pre>

    <h2>Response Format</h2>

    <pre><code>{
  "status": "success" | "error",
  "statusCode": number,
  "data": any,           // Present on success
  "message": string      // Present on error
}</code></pre>

    <h2>Validation Requirements</h2>

    <h3>Handle Standardization</h3>

    <p>Handle requirements:</p>
    <ul>
        <li>Length: 3-30 characters</li>
        <li>Allowed characters: lowercase letters (a-z), numbers (0-9), underscores (_)</li>
        <li>Pattern: /^[a-z0-9_]{3,30}$/</li>
    </ul>

    <p>While handles must ultimately be lowercase, the API is forgiving of uppercase letters in input. However, all other requirements are strictly enforced.</p>

    <p>Examples:</p>
    <ul>
        <li>✅ "john_doe" → accepted as "john_doe"</li>
        <li>✅ "JOHN_DOE" → accepted as "john_doe"</li>
        <li>❌ "john-doe" → rejected with error "only lowercase letters, numbers, and underscores are allowed"</li>
        <li>❌ "john.doe" → rejected with error "only lowercase letters, numbers, and underscores are allowed"</li>
        <li>❌ "jo" → rejected with error "must be between 3 and 30 characters long"</li>
    </ul>

    <p>Handle processing:</p>
    <ol>
        <li>Sanitization (as data enters API):
            <ul>
                <li>Converts to lowercase</li>
                <li>No other character transformations</li>
            </ul>
        </li>
        <li>Validation:
            <ul>
                <li>Verifies length (3-30 characters)</li>
                <li>Verifies only allowed characters are present</li>
                <li>Provides specific error messages for different validation failures</li>
            </ul>
        </li>
    </ol>

    <h3>Basic Schema Structure</h3>
    <pre><code>import { ValidationSchema } from '../../middleware/types';

export const exampleSchema: ValidationSchema = {
  field: {
    sanitizer: s.sanitizeType,
    validator: v.validateType,
    required: boolean
  }
};</code></pre>

    <h3>Required Fields</h3>
    <pre><code>export const createAccountSchema: ValidationSchema = {
  ownerID: {
    sanitizer: s.sanitizeUUID,
    validator: v.validateUUID,
    required: true
  }
};</code></pre>

    <h3>Complex Validation</h3>
    <p>For schemas requiring at least one of multiple fields:</p>
    <pre><code>import { RequireAtLeastOne } from '../../middleware/types';

export const getAccountSchema: RequireAtLeastOne<{
  accountID: {
    sanitizer: s.sanitizeUUID,
    validator: v.validateUUID,
    required: false
  },
  accountHandle: {
    sanitizer: s.sanitizeHandle,
    validator: v.validateHandle,
    required: false
  }
}> = {
  accountID: {
    sanitizer: s.sanitizeUUID,
    validator: v.validateUUID,
    required: false
  },
  accountHandle: {
    sanitizer: s.sanitizeHandle,
    validator: v.validateHandle,
    required: false
  },
  $atLeastOne: ['accountID', 'accountHandle']
};</code></pre>

    <h2>Error Handling</h2>

    <p>All routes must implement consistent error handling:</p>

    <pre><code>router.post('/endpoint',
  validateRequest(schema),
  controller,
  errorHandler
);</code></pre>

    <h2>Implementation Checklist</h2>

    <p>When implementing or updating an endpoint, ensure:</p>
    <ul>
        <li>Uses POST method</li>
        <li>Follows path format standards (no module prefix except admin/devadmin)</li>
        <li>Implements proper validation schema with correct types</li>
        <li>Uses errorHandler middleware</li>
        <li>Returns standardized response format</li>
        <li>Follows module structure</li>
    </ul>

</body>
</html>
