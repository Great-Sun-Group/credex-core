name: Deploy to AWS Development

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Deployment environment"
        required: true
        default: "development"

env:
  ECR_REPOSITORY: credex-core-development
  ECS_CLUSTER: credex-cluster-development
  ECS_SERVICE: credex-core-service-development
  CONTAINER_NAME: credex-core
  TF_VAR_environment: development

jobs:
  deploy:
    name: Deploy to AWS Development
    runs-on: ubuntu-latest
    environment: development

    steps:
      - name: Checkout code
        uses: actions/checkout@v2
        with:
          ref: dev

      - name: Set up environment
        run: |
          echo "Setting up environment: development"

      - name: Debug - List all secrets and environment variables
        env:
          AWS_ACCESS_KEY: ${{ secrets.AWS_ACCESS_KEY }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          WHATSAPP_BOT_API_KEY: ${{ secrets.WHATSAPP_BOT_API_KEY }}
          OPEN_EXCHANGE_RATES_API: ${{ secrets.OPEN_EXCHANGE_RATES_API }}
          NEO_4J_LEDGER_SPACE_BOLT_URL: ${{ secrets.NEO_4J_LEDGER_SPACE_BOLT_URL }}
          NEO_4J_LEDGER_SPACE_USER: ${{ secrets.NEO_4J_LEDGER_SPACE_USER }}
          NEO_4J_LEDGER_SPACE_PASS: ${{ secrets.NEO_4J_LEDGER_SPACE_PASS }}
          NEO_4J_SEARCH_SPACE_BOLT_URL: ${{ secrets.NEO_4J_SEARCH_SPACE_BOLT_URL }}
          NEO_4J_SEARCH_SPACE_USER: ${{ secrets.NEO_4J_SEARCH_SPACE_USER }}
          NEO_4J_SEARCH_SPACE_PASS: ${{ secrets.NEO_4J_SEARCH_SPACE_PASS }}
        run: |
          echo "Available secrets:"
          echo '${{ toJson(secrets) }}' | jq 'keys'
          echo "Environment variables:"
          env | grep -v -e '^GITHUB_' -e '^RUNNER_' -e '^ACTIONS_' | sort

      - name: Validate environment variables
        env:
          AWS_ACCESS_KEY: ${{ secrets.AWS_ACCESS_KEY }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          WHATSAPP_BOT_API_KEY: ${{ secrets.WHATSAPP_BOT_API_KEY }}
          OPEN_EXCHANGE_RATES_API: ${{ secrets.OPEN_EXCHANGE_RATES_API }}
          NEO_4J_LEDGER_SPACE_BOLT_URL: ${{ secrets.NEO_4J_LEDGER_SPACE_BOLT_URL }}
          NEO_4J_LEDGER_SPACE_USER: ${{ secrets.NEO_4J_LEDGER_SPACE_USER }}
          NEO_4J_LEDGER_SPACE_PASS: ${{ secrets.NEO_4J_LEDGER_SPACE_PASS }}
          NEO_4J_SEARCH_SPACE_BOLT_URL: ${{ secrets.NEO_4J_SEARCH_SPACE_BOLT_URL }}
          NEO_4J_SEARCH_SPACE_USER: ${{ secrets.NEO_4J_SEARCH_SPACE_USER }}
          NEO_4J_SEARCH_SPACE_PASS: ${{ secrets.NEO_4J_SEARCH_SPACE_PASS }}
        run: |
          required_vars=(
            "AWS_ACCESS_KEY"
            "AWS_SECRET_ACCESS_KEY"
            "JWT_SECRET"
            "WHATSAPP_BOT_API_KEY"
            "OPEN_EXCHANGE_RATES_API"
            "NEO_4J_LEDGER_SPACE_USER"
            "NEO_4J_LEDGER_SPACE_PASS"
            "NEO_4J_SEARCH_SPACE_USER"
            "NEO_4J_SEARCH_SPACE_PASS"
          )

          for var in "${required_vars[@]}"; do
            if [ -z "${!var}" ]; then
              echo "Error: $var is not set. Please ensure this secret is added to the 'development' environment in GitHub."
              exit 1
            else
              echo "$var is set"
            fi
          done

          # Check optional variables
          optional_vars=(
            "NEO_4J_LEDGER_SPACE_BOLT_URL"
            "NEO_4J_SEARCH_SPACE_BOLT_URL"
          )

          for var in "${optional_vars[@]}"; do
            if [ -z "${!var}" ]; then
              echo "Warning: $var is not set. This is optional and will be set during the first deployment if not provided."
            else
              echo "$var is set"
            fi
          done

          echo "All required environment variables are set."

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: af-south-1

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v1

      - name: Build, tag, and push image to Amazon ECR
        id: build-image
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG .
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
          echo "image=$ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG" >> $GITHUB_OUTPUT

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v1

      - name: Terraform Init
        run: terraform init
        working-directory: ./terraform

      - name: Terraform Plan
        id: plan
        run: |
          terraform plan \
            -var="environment=development" \
            -var="jwt_secret=${{ secrets.JWT_SECRET }}" \
            -var="whatsapp_bot_api_key=${{ secrets.WHATSAPP_BOT_API_KEY }}" \
            -var="open_exchange_rates_api=${{ secrets.OPEN_EXCHANGE_RATES_API }}" \
            -var="neo4j_ledger_space_bolt_url=${{ secrets.NEO_4J_LEDGER_SPACE_BOLT_URL }}" \
            -var="neo4j_ledger_space_user=${{ secrets.NEO_4J_LEDGER_SPACE_USER }}" \
            -var="neo4j_ledger_space_pass=${{ secrets.NEO_4J_LEDGER_SPACE_PASS }}" \
            -var="neo4j_search_space_bolt_url=${{ secrets.NEO_4J_SEARCH_SPACE_BOLT_URL }}" \
            -var="neo4j_search_space_user=${{ secrets.NEO_4J_SEARCH_SPACE_USER }}" \
            -var="neo4j_search_space_pass=${{ secrets.NEO_4J_SEARCH_SPACE_PASS }}" \
            -out=tfplan
        working-directory: ./terraform

      - name: Terraform Apply
        id: apply
        run: terraform apply -auto-approve tfplan
        working-directory: ./terraform

      - name: Update ECS task definition
        id: task-def
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          sed -i.bak \
            -e 's|${CONTAINER_IMAGE}|'${ECR_REGISTRY}/${ECR_REPOSITORY}:${IMAGE_TAG}'|' \
            -e 's|${NODE_ENV}|development|' \
            -e 's|${LOG_LEVEL}|debug|' \
            -e 's|${AWS_REGION}|af-south-1|' \
            terraform/task-definition.json
          echo "task-definition=terraform/task-definition.json" >> $GITHUB_OUTPUT

      - name: Deploy Amazon ECS task definition
        uses: aws-actions/amazon-ecs-deploy-task-definition@v1
        with:
          task-definition: ${{ steps.task-def.outputs.task-definition }}
          service: ${{ env.ECS_SERVICE }}
          cluster: ${{ env.ECS_CLUSTER }}
          wait-for-service-stability: true

      - name: Check ECS Service Status
        run: |
          ./terraform/check_ecs_status.sh ${{ env.ECS_CLUSTER }} ${{ env.ECS_SERVICE }}

      - name: Run Post-Deployment Tests
        env:
          API_URL: ${{ steps.apply.outputs.api_url }}
        run: |
          npm install axios jest
          node .github/workflows/post_deployment_tests.js

      - name: Log deployment
        if: success()
        run: |
          echo "Deployment to development triggered by ${{ github.actor }} at $(date)" >> deployment_log.txt
          git config user.name github-actions
          git config user.email github-actions@github.com
          git add deployment_log.txt
          git commit -m "Log deployment to development"
          git push
        working-directory: ./terraform

      - name: Notify on Failure
        if: failure()
        run: |
          echo "Deployment failed. Please check the logs for more information."
          # Add notification mechanism here (e.g., send an email, Slack message, etc.)
