version: '3.8'

services:
  server:
    build:
      context: .
      target: ${BUILD_TARGET:-development}
    environment:
      NODE_ENV: ${NODE_ENV:-development}
      PORT: ${PORT:-5000}
      LOG_LEVEL: ${LOG_LEVEL:-debug}
      JWT_SECRET: ${JWT_SECRET}
      WHATSAPP_BOT_API_KEY: ${WHATSAPP_BOT_API_KEY}
      OPEN_EXCHANGE_RATES_API_KEY: ${OPEN_EXCHANGE_RATES_API_KEY}
      NEO4J_LEDGER_SPACE_BOLT_URL: ${NEO4J_LEDGER_SPACE_BOLT_URL}
      NEO4J_LEDGER_SPACE_USER: ${NEO4J_LEDGER_SPACE_USER}
      NEO4J_LEDGER_SPACE_PASS: ${NEO4J_LEDGER_SPACE_PASS}
      NEO4J_SEARCH_SPACE_BOLT_URL: ${NEO4J_SEARCH_SPACE_BOLT_URL}
      NEO4J_SEARCH_SPACE_USER: ${NEO4J_SEARCH_SPACE_USER}
      NEO4J_SEARCH_SPACE_PASS: ${NEO4J_SEARCH_SPACE_PASS}
    ports:
      - "${PORT:-5000}:5000"
    volumes:
      - ./logs:/app/logs
      - .:/app
      - /app/node_modules
    restart: unless-stopped

  cloudwatch-agent:
    image: amazon/cloudwatch-agent:latest
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      AWS_REGION: ${AWS_REGION:-us-east-1}
    profiles:
      - aws
